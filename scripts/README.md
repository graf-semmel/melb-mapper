# Scripts Developer README

## Overview

This directory contains Bash scripts for downloading geographic data from OpenStreetMap using the Overpass API and Nominatim geocoding service. The scripts output results as JSON and GeoJSON files, suitable for use in mapping and data analysis projects.

## Scripts

### `fetch-capital-cities.sh`
Downloads capital city data for a country.

### `fetch-suburb.sh`
Downloads suburb/administrative boundary data for a city.

### `common.sh`
Shared utility functions used by the other scripts.

## Requirements
- macOS or Linux
- [jq](https://stedolan.github.io/jq/) (for JSON processing)
- [curl](https://curl.se/) (for HTTP requests)
- [osmtogeojson](https://github.com/tyrasd/osmtogeojson) (for converting OSM JSON to GeoJSON)

Install dependencies using Homebrew and npm:
```sh
brew install jq curl
npm install osmtogeojson
```

## Usage

### fetch-capital-cities.sh

Downloads capital cities for a country using Nominatim geocoding.

```sh
sh fetch-capital-cities.sh [OPTIONS] COUNTRY_NAME
```

**Options:**
- `-v` : Enable verbose debug output

**Examples:**
```sh
sh fetch-capital-cities.sh "Australia"
sh fetch-capital-cities.sh -v "Germany"
sh fetch-capital-cities.sh "United States"
```

**Output files** (for "Australia"):
- `geo/australia.capital-cities.osm.json` - Raw OSM JSON
- `geo/australia.capital-cities.json` - Simplified JSON with city names

### fetch-suburb.sh

Downloads suburb/administrative boundaries (admin_level 9) for a city.

```sh
sh fetch-suburb.sh [OPTIONS] CITY_NAME COUNTRY
```

**Options:**
- `-v` : Enable verbose debug output

**Examples:**
```sh
sh fetch-suburb.sh "Melbourne" "Australia"
sh fetch-suburb.sh -v "Brisbane" "Australia"
sh fetch-suburb.sh "Munich" "Germany"
```

**Output files** (for "Melbourne"):
- `geo/melbourne.suburbs.osm.json` - Raw OSM JSON
- `geo/melbourne.suburbs.json` - GeoJSON with suburb polygons
- `geo/melbourne.bounds.json` - Bounding box coordinates

## Output Files

Output filenames are generated by converting the input name to lowercase and replacing spaces with hyphens.

Examples:
- `"Australia"` → `australia.capital-cities.json`
- `"Melbourne"` → `melbourne.suburbs.json`
- `"City of Brisbane"` → `city-of-brisbane.suburbs.json`

## How It Works

1. **Dependency Check:** Ensures `jq` and `curl` are installed.
2. **Geocoding:** Uses Nominatim API to resolve location names to OSM area IDs.
   - Handles name variations (e.g., "Germany" or "Deutschland")
   - Converts OSM IDs to Overpass area IDs
3. **Query Construction:** Builds Overpass API queries using the area ID.
4. **API Request:** Sends the query to the Overpass API and saves the response.
5. **Processing:**
   - Capital cities: Extracts city names from node tags
   - Suburbs: Converts OSM JSON to GeoJSON, filters polygons, calculates bounds
6. **Output:** Saves results to the `geo/` directory.

## Troubleshooting

- **Dependencies missing:** Ensure `jq`, `curl`, and `osmtogeojson` are installed and in your PATH.
- **Geocoding fails:** Check spelling of location names. Try alternative names (e.g., "USA" vs "United States").
- **Overpass API slow/unresponsive:** The public API can be busy. Try again later or use a different instance.
- **No results found:** The location might not have admin_level 9 subdivisions, or use a different administrative structure.

## Technical Notes

### Nominatim Geocoding

The scripts use the Nominatim API to convert location names to OSM area IDs:
- Relation IDs: `area_id = osm_id + 3600000000`
- Way IDs: `area_id = osm_id + 2400000000`
- Node IDs: `area_id = osm_id` (rarely used for areas)

### Overpass API Queries

Unlike Overpass Turbo's web interface, the raw Overpass API doesn't support `{{geocodeArea:...}}` syntax. The scripts handle this by:
1. Geocoding via Nominatim first
2. Using the numeric area ID: `area(3600080500)`

## Example Overpass API Queries

These queries work in [Overpass Turbo](https://overpass-turbo.eu/) (which supports `{{geocodeArea:...}}`). The scripts convert these to use numeric area IDs for direct API compatibility.

### Get suburbs (admin_level 9) for Melbourne
```overpass
[out:json][timeout:25];
{{geocodeArea:Melbourne, Australia}}->.searchArea;
(
  relation["boundary"="administrative"]["admin_level"="9"](area.searchArea);
);
out geom;
```

### Get state capitals of Australia
```overpass
[out:json][timeout:25];
{{geocodeArea:Australia}}->.searchArea;
(
  node["place"="city"]["capital"="4"](area.searchArea);
);
out body;
```

### What the scripts actually send to Overpass API
```overpass
[out:json][timeout:25];
area(3600080500)->.searchArea;
(
  node["place"="city"]["capital"="4"](area.searchArea);
);
out body;
```

## Known Issues
- Perth's suburbs are not clustered like other cities, leading to separate files for each local government area according to [Perth metropolitan region - Subregions and local government areas](https://en.wikipedia.org/wiki/Perth_metropolitan_region#Subregions_and_local_government_areas). The current script only collects suburbs from the "Inner Metro Area". Kings Park is not part of any local government area and is therefore not included.